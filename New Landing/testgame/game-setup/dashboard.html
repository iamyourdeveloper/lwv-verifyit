<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />
   <!-- <link rel="shortcut icon" href="/retail/images/favicon.ico"> -->
  <title>Dashboard - VerifyIt</title>
  <!-- <link href="../css/style.css" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="../game-setup/style-dashboard.css">
  <script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
  <script src="../../js/lib.js"></script>
  <script src="../../js/iziToast.min.js" type="text/javascript"></script>
  <style>
    @import "../../css/mini-default.min.css";
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap');
    @import "../../css/iziToast.min.css";

    * {
      font-family: Quicksand, arial, sans, sans-serif;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    body {
      width: clamp(340px, 90%, 800px);
      margin: auto;
    }  
    ul {
      list-style-type: none;
    }
    #game-over {
      text-align: center;
      background-color: darkred;
      color: yellow;
    }
  </style>
</head>
<body>
  <div class="background">
    <span><img src="img/check-mark.png" alt="" class="span-check"></span>
    <span class="dot"></span>
    <span class="dot"></span>
    <span><img src="img/check-mark.png" alt="" class="span-check"></span>
    <span class="dot"></span>
    <span>
      <div class="sub-ver-back sub-ver-back-dot">
        <div class="ver-checkbox">
            <img src="img/check-mark.png" alt="" class="ver-check">
        </div>
        <p class="ver-p1">E R I F Y</p>
        <p class="ver-p2">I T !</p>
      </div>
    </span>
    <span class="dot"></span>
    <span><img src="img/check-mark.png" alt="" class="span-check"></span>
    <span class="dot"></span>
    <span class="dot"></span>
    <span>
      <div class="sub-ver-back sub-ver-back-dot">
        <div class="ver-checkbox">
            <img src="img/check-mark.png" alt="" class="ver-check">
        </div>
        <p class="ver-p1">E R I F Y</p>
        <p class="ver-p2">I T !</p>
      </div>
    </span>
    <span><img src="img/check-mark.png" alt="" class="span-check"></span>
    <span class="dot"></span>
    <span>
      <div class="sub-ver-back sub-ver-back-dot">
        <div class="ver-checkbox">
            <img src="img/check-mark.png" alt="" class="ver-check">
        </div>
        <p class="ver-p1">E R I F Y</p>
        <p class="ver-p2">I T !</p>
      </div>
    </span>
    <span><img src="img/check-mark.png" alt="" class="span-check"></span>
    <span class="dot"></span>
    <span><img src="img/check-mark.png" alt="" class="span-check"></span>
    <span class="dot"></span>
    <span class="dot"></span>
    <span class="dot"></span>
  </div>
  <div>
    <fieldset><legend>Game of</legend>
      <h1 id="game-name"></h1>
      <h4 id="leader-profile"></h4>
    </fieldset>
    <fieldset id="share-play" hidden>
      <legend>Invite your players</legend>
      <h2 style="text-align:center;">Game is ready. Share the url below with your players.</h2>
      <p>By pressing the Copy button, you'll copy the url to the clipboard. Then paste it in a text, chat or email
      to the players.  Or you can give them this url:
      <p>
        <span id="game-url" style="padding:1rem; font-weight:bold;">(game url here)</span>
        <button type="button" id="btn-copy">&#128203; Copy</button>
        <button type="button" id="btn-play">Play Yourself</button>
      </p>
      <h2 style="color:firebrick;text-align:center;">KEEP THIS PAGE OPEN UNTIL THE GAME IS OVER!</h2>
    </fieldset>

    <fieldset id="question-list"><legend>Questions</legend>
      <ol></ol>
    </fieldset>
    <fieldset id="player-list" style="width:53rem"><legend>Players</legend>
      <table>
        <thead>
        </thead>
        <tbody>
        </tbody>
      </table>
    </fieldset>
    <div class="shadowed" id="game-over" hidden><h2 class="toast">GAME OVER!</h2></div>
    <div class="shadowed" id="preparing-game"><h2 class="toast">Preparing game. Stand by...</h2></div>

    <!-- <fieldset>
      <legend>Game setup</legend>
      <label for="play_code">Game Code</label>
      <input type="text" id="play_code" type="number" placeholder="A four digit number"/>
      <button type="button" id="btn-copy" style="visibility:hidden">&#128203; Copy</button>
      <button type="button" id="btn-play" style="visibility:hidden">Play Yourself</button>
      <fieldset id="game-setup">
        <legend>Choose a Game Topic</legend>
        <div class="collapse">
          <input type="radio" aria-hidden="true" name="accordion">
          <label aria-hidden="true">(game group name goes here)</label>
          <div>
            <ul></ul>
          </div>
        </div>
        <button id="btn-open-game">Start the new game</button>
      </fieldset>
    </fieldset>
    <div id="game-start" hidden>
      <h2 style="text-align:center;">Game is ready. Distribute the game code to players.</h2>
      <p>By pressing the Copy button above, you'll copy the url to the clipboard. Then paste it in a text, chat or email
      to the players.  Or you can give them this url and the game code:
      <p id="game-url" style="padding:1rem">(game url here)</p>
      <p>and they can enter the game themselves.</p>
      <h2 style="color:firebrick;text-align:center;">KEEP THIS PAGE OPEN UNTIL THE GAME IS OVER!</h2>
      <p style="font-weight: bold">GAME: <span id="game-name" ></span></p>
      <p id="points-per-q"></p>
      </fieldset>
      <fieldset id="question-list"><legend>Questions</legend>
        <ol></ol>
      </fieldset>
      <fieldset id="player-list" style="width:53rem"><legend>Players</legend>
        <table>
          <thead>
          </thead>
          <tbody>
          </tbody>
        </table>
      </fieldset>
      <h1 id="game-over" hidden>Game Over.</h1>
    </div>
  -->
  </div>

  <script>

    // var curQuestionNo = 0
    var poll = null // interval handle

    async function fetchQuestions(game) {
      let gc = await request(`game_category?select=categories,no_questions&game=eq.${game}`)
      // console.log('gc', gc)
      let result = await Promise.all(gc.filter( cat => cat.no_questions > 0 ).map( async cat => {
        const buf = await request( `random_question?select=title&game=eq.${game}&categories=eq.${cat.categories}&limit=${cat.no_questions}`)
        return buf.map( r => ({title: r.title, categories: cat.categories}) )
      }))
      return result.flat().sort(() => Math.random() - 0.5).map( (r,i) => ({title: r.title, categories: r.categories, sequence: i}) )
    }
    // function checkGameOver() {
    //   const playerLines = Array.from($('#player-list tbody').children)
    //   const finishers = playerLines.filter( tr => tr.innerHTML.includes('<strong>Final</strong>') )
    //   // console.log('finishers', finishers, finishers.length, 'of', playerLines.length, 'are finished')
    //   if (finishers.length == playerLines.length) {
    //     // const finalScores = finishers.map( tr => {
    //     //   return {
    //     //     handle: tr.dataset.name, 
    //     //     score: Number(tr.querySelector('td:nth-child(3)').textContent.split(' Final')[0])
    //     //   }
    //     // }).sort( (a,b) => b.score - a.score )
    //     // console.log('finalScores', finalScores)
    //     // const roomName = Object.keys(drone.rooms)[0]
    //     // drone.publish({room: roomName, message: {finalScores}})
    //     $('#game-over').hidden = false
    //   }
    // }
    function monitorPlay(questions, playId) {
      // function dashName(msg) {
      //   return msg.clientData.name.replaceAll(' ', '-')
      // }
      async function pollPlay() {
        const status = await request(`player?play=eq.${playId}`)
        // console.log('  pollPlay', playId, status)
        $('#player-list tbody').innerHTML = ''
        status.forEach(player => {
          const paddedScores = player.question_scores.concat(Array(questions.length - player.question_scores.length).fill('-'));
          const cols = paddedScores.map( i => `<td style="max-width:3rem">${i}</td>` ).join('')
          // console.log('    cols', cols)
          $('#player-list tbody').innerHTML += `<tr data-name="${player.handle}"><td style="min-width:5rem">${player.handle}</td>${cols}<td style="max-width:4rem"></td></tr>`




      //     if ($(`tr[data-name=${dashName(m.member)}]`) == null ) {
      //       const cols = questions.map( (q, i) => `<td style="max-width:3rem"></td>` ).join('')
      //       $('#player-list tbody').innerHTML += `<tr data-name="${dashName(m.member)}"><td>${m.member.clientData.name}</td>${cols}<td></td><td></td></tr>`
      //     }
      //     $(`tr[data-name=${dashName(m.member)}] > td:nth-child(${m.data.questionNo+1})`).innerHTML = `${m.data.qScore}`
      //     // $(`tr[data-name=${dashName(m.member)}] > td:nth-child(${questions.length+2})`).innerHTML = m.data.bonus
      //     if (m.data.questionNo == questions.length)
      //       $(`tr[data-name=${dashName(m.member)}] > td:nth-child(${questions.length+2})`).innerHTML = `${m.data.gScore} <strong>Final</strong>`
      //     else
      //       $(`tr[data-name=${dashName(m.member)}] > td:nth-child(${questions.length+2})`).innerHTML = m.data.gScore







        })
      }
      const cols = questions.map( (q, i) => `<th style="max-width:3rem">#${i+1}</th>` ).join('')
      $('#player-list thead').innerHTML = `<tr><th style="min-width:5rem">Player</th>${cols}<th style="max-width:4rem">Total</th></tr>`
      console.log('monitorPlayer', questions)
      poll = setInterval(pollPlay, 5000)

    }

    async function preparePlay(game, game_leader, is_teacher, school, grade, city) {
      console.log('preparePlay', game, game_leader, is_teacher, school, grade, city)
      $('#game-name').innerHTML = game
      $('#leader-profile').innerHTML = 'For ' + game_leader + (is_teacher ? `, ${school}, grade ${grade}, ${city}` : ' (non-teacher)')

      const row = is_teacher ? {leader_handle: game_leader, is_teacher, school, grade, city} : {leader_handle: game_leader, is_teacher}
      console.log('row', row)
      await request('game_leader', [row], {isUpsert: true})
      const resp = await fetch('https://ipapi.co/json')
      const here = await resp.json()
      const location = `${here.city}, ${here.region_code}`
      const playId = (await request('play', {game, game_leader, location}))[0].play
      console.log('  location', location, 'id', playId)

      const updatedLeader = await request(`game_leader?leader_handle=eq.${game_leader}`, {current_play: playId})
      console.log('updatedLeader', updatedLeader[0])
      const questions = await fetchQuestions(game)
      console.log(questions)
      $('#preparing-game').style.display = 'none'

      const gameUrl = window.location.href.replace(/game-setup.*/, '') + `#gameLeader=${game_leader}`
      console.log('gameUrl', gameUrl)
      $('#btn-copy').onclick = evt => {
        navigator.clipboard.writeText(gameUrl)
        iziToast.show({title: 'Copied to clipboard.'})
      }
      $('#btn-play').onclick = evt => {
        window.open(gameUrl)
      }
      $('#game-url').textContent = gameUrl
      $('#share-play').style.display = 'block'

      $('#question-list ol').innerHTML = questions.map( (r, i) => `<li id="question-${i}">${r.title}</li>` ).join('\n') 
      
      await request('question_play', questions.map( r => ({question: r.title, play: playId, categories: r.categories, sequence: r.sequence}) ))
      monitorPlay(questions, playId)
    }

    async function main() {
      let params = {}
      new URLSearchParams(location.hash.slice(1)).forEach( (v, k) => params[k] = `${v}`)
      preparePlay(params.gameName, params.handleMultiplayer || params.handleTeacher, !!params.handleTeacher, params.school, Number(params.grade), params.city)



      // // var players = []
      // var questions = []
      // let codeElem = $('#play_code')
      // codeElem.value = Math.floor(Math.random()*9999)
      // let gameUrl = location.href.replace(/game-runner.*/, '')
      // let games = {Civics: [], Voting: [], News: []} // team asked for these to be the first three game groups listed
      // let buf = await request('game?select=name,description,game_group,game_category(no_questions)&name=neq.(none)&game_status=eq.Production&game_group=not.is.null&order=game_group,name')
      // buf.forEach(row => {
      //   if (!games[row.game_group]) games[row.game_group] = []
      //   games[row.game_group].push(row)
      // })
      // // console.log('games', games)
      // let container = $('#game-setup .collapse')
      // let groupTmpl = document.createElement('div')
      // while (container.firstElementChild) groupTmpl.appendChild(container.removeChild(container.firstElementChild))
      // // console.log('groupTmpl', groupTmpl)
      // Object.keys(games).forEach( (gn, i) => {
      //   let newItem = groupTmpl.cloneNode(true)
      //   let input = newItem.querySelector('input')
      //   let label = newItem.querySelector('label')
      //   let content = newItem.querySelector('div ul')
      //   // console.log('  group', gn, i, input, label, content)

      //   input.id = `group-${i}`
      //   if (i == 0) input.checked = true
      //   label.setAttribute('for', input.id)
      //   label.innerHTML = `▶&nbsp;&nbsp;${gn}`
      //   content.innerHTML = games[gn].map (r => {
      //     let cs = r.game_category.length
      //     if (cs == 0) return ''
      //     let qs = r.game_category.map( gc => gc.no_questions ).reduce( (a,c) => a + c , 0)

      //     return `<li><label>
      //       <input type="radio" name="game" value="${r.name}"" />
      //       <strong title="${r.description}">${r.name}</strong> - up to ${qs} questions
      //       </label></li>` 
      //   }).join('\n')
        
      //   while (newItem.firstElementChild) container.appendChild(newItem.removeChild(newItem.firstElementChild))
      // })
   
      // $('#btn-open-game').onclick = async evt => {
      //   evt.preventDefault()
      //   const checked = $('input[name=game]:checked')
      //   if (checked == null) {
      //     alert('Please select a Game Plan first.')
      //     return
      //   }
      //   const game = checked.value
      //   const play_code = codeElem.value

      //   const resp = await fetch('https://ipapi.co/json')
      //   const here = await resp.json()
      //   const location = `${here.city}, ${here.region_code}`
      //   const playId = (await request('play', {game, play_code, location}))[0].play
      //   // console.log('play', game, play_code, location, playId)
      //   const questions = await fetchQuestions(game)
      //   // console.log(questions)
      //   const cols = questions.map( (q, i) => `<th style="max-width:3rem">#${i+1}</th>` ).join('')
      //   $('#player-list thead').innerHTML = `<tr><th style="min-width:5rem">Player</th>${cols}<th style="max-width:4rem">Total</th></tr>`

      //   await request('question_play', questions.map( r => ({question: r.title, play: playId, categories: r.categories, sequence: r.sequence}) ))

      //   drone = new Scaledrone('s8VguFUX78IuhUH5', {data: {name: '** Game Runner **', play: playId}})
      //   drone.on('open', evt => console.log('Channel opened.', evt) )
      //   drone.on('err', err => alert(`Game channel failed to open: ${JSON.stringify(err)}`) )
      //   drone.on('close', evt => console.log('Channel closed.', evt) )

      //   const room = drone.subscribe(`observable-game-${codeElem.value}`)
      //   // room.on('open', err => err && alert(`Game room failed to open: ${JSON.stringify(err)}`) )
      //   room.on('open', evt => console.log('Room opened.', evt) )
      //   room.on('err', err => alert(`Game room failed to open: ${JSON.stringify(err)}`) )
      //   room.on('close', evt => console.log('Room closed.', evt) )
      //   // room.on('members', m => players = m )
      //   room.on('member_join', m => {
      //     // console.log('member joined', m)
      //     // players.push(m)
      //     if (m.clientData && m.clientData.name) {
      //       const cols = questions.map( (q, i) => `<td style="max-width:3rem"></td>` ).join('')
      //       $('#player-list tbody').innerHTML += `<tr data-name="${dashName(m)}"><td style="min-width:5rem">${m.clientData.name}</td>${cols}<td style="max-width:4rem"></td></tr>`
      //     }
      //     // $('#player-list tbody').innerHTML = players.filter( p => p.clientData.name )
      //     //   .map( p => `<tr data-name="${p.clientData.name}"><td>${p.clientData.name}</td><td></td><td></td><td></td></tr>` ).join('\n')
      //     // // $('#player-list ul').innerHTML = players.map( p => `<li>${p.clientData.name}</li>` ).join('\n') 
      //   })
      //   room.on('member_leave', m => {
      //     console.log('member left', m)
      //     // const index = players.findIndex(m => m.id === id)
      //     // players.splice(index, 1)
      //     if (m.clientData && m.clientData.name && $(`tr[data-name=${dashName(m)}]`)) {
      //       iziToast.show({title: `${m.clientData.name} left the game.`})
      //       // const node = $(`tr[data-name=${dashName(m)}]`)
      //       // node.parentElement.removeChild(node)
      //       const node = $(`tr[data-name=${dashName(m)}] td`)
      //       node.style.backgroundColor = 'indianred'
      //     }
      //   })

      //   room.on('message', m => {
      //     // console.log('message', m)
      //     if (!(m.member && m.member.clientData && m.member.clientData.name) || m.member.clientData.name.startsWith('**')) return
      //     // console.log('player', m.member.clientData.name, 'question', m.data.questionNo, 'of', questions.length)
      //     if ($(`tr[data-name=${dashName(m.member)}]`) == null ) {
      //       const cols = questions.map( (q, i) => `<td style="max-width:3rem"></td>` ).join('')
      //       $('#player-list tbody').innerHTML += `<tr data-name="${dashName(m.member)}"><td>${m.member.clientData.name}</td>${cols}<td></td><td></td></tr>`
      //     }
      //     $(`tr[data-name=${dashName(m.member)}] > td:nth-child(${m.data.questionNo+1})`).innerHTML = `${m.data.qScore}`
      //     // $(`tr[data-name=${dashName(m.member)}] > td:nth-child(${questions.length+2})`).innerHTML = m.data.bonus
      //     if (m.data.questionNo == questions.length)
      //       $(`tr[data-name=${dashName(m.member)}] > td:nth-child(${questions.length+2})`).innerHTML = `${m.data.gScore} <strong>Final</strong>`
      //     else
      //       $(`tr[data-name=${dashName(m.member)}] > td:nth-child(${questions.length+2})`).innerHTML = m.data.gScore
      //     checkGameOver()
      //   })
      //   $('#game-name').textContent = game
      //   $('#points-per-q').textContent = `${Math.floor(1200 / questions.length)} max points per question.`
      //   $('#question-list ol').innerHTML = questions.map( (r, i) => `<li id="question-${i}">${r.title}</li>` ).join('\n') 

      //   $('#game-setup').hidden = true
      //   $('#game-start').hidden = false
      //   $('#btn-copy').style.visibility = 'visible'
      //   $('#btn-play').style.visibility = 'visible'
      // }
    }

    main()


  </script>
</body>
</html>
