<!DOCTYPE html> 
<html class="js-focus-visible" data-js-focus-visible="">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <link rel="stylesheet" href="../../mini-css/mini-default.min.css">
  <link rel="stylesheet" href="../../style-t-dash.css">
   <!-- <link rel="shortcut icon" href="/retail/images/favicon.ico"> -->
  <title>Game Setup</title>
  <!-- <link href="../css/style.css" rel="stylesheet" type="text/css"> -->
  <script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
  <script src="../../js/lib.js"></script>
  <script src="../../js/iziToast.min.js" type="text/javascript"></script>
  <style>
    /* @import "../../css/mini-default.min.css"; */
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap');
    /* @import "../css/iziToast.min.css"; */
    @import url("https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css");

    * {
      font-family: Quicksand, arial, sans, sans-serif;
      margin: 0;
      padding: 0;
    }
    body {
      width: clamp(320px, 90%, 800px);
      margin: auto !important;
    }  
    ul {
      list-style-type: none;
    }
  </style>
  <style type="text/css">
    @font-face {
      font-weight: 400;
      font-style:  normal;
      font-family: 'Circular-Loom';
    
      src: url('https://cdn.loom.com/assets/fonts/circular/CircularXXWeb-Book-cd7d2bcec649b1243839a15d5eb8f0a3.woff2') format('woff2');
    }
    
    @font-face {
      font-weight: 500;
      font-style:  normal;
      font-family: 'Circular-Loom';
    
      src: url('https://cdn.loom.com/assets/fonts/circular/CircularXXWeb-Medium-d74eac43c78bd5852478998ce63dceb3.woff2') format('woff2');
    }
    
    @font-face {
      font-weight: 700;
      font-style:  normal;
      font-family: 'Circular-Loom';
    
      src: url('https://cdn.loom.com/assets/fonts/circular/CircularXXWeb-Bold-83b8ceaf77f49c7cffa44107561909e4.woff2') format('woff2');
    }
    
    @font-face {
      font-weight: 900;
      font-style:  normal;
      font-family: 'Circular-Loom';
    
      src: url('https://cdn.loom.com/assets/fonts/circular/CircularXXWeb-Black-bf067ecb8aa777ceb6df7d72226febca.woff2') format('woff2');
    }
</style>
</head>
<body style="cursor: auto;">
  <div class="background">
    <span><img src="../../img/check-mark.png" alt="" class="span-check"></span>
    <span class="dot"></span>
    <span class="dot"></span>
    <span><img src="../../img/check-mark.png" alt="" class="span-check"></span>
    <span class="dot"></span>
    <span>
      <div class="sub-ver-back sub-ver-back-dot">
        <div class="ver-checkbox">
            <img src="../../img/check-mark.png" alt="" class="ver-check">
        </div>
        <p class="ver-p1">E R I F Y</p>
        <p class="ver-p2">I T !</p>
      </div>
    </span>
    <span class="dot"></span>
    <span><img src="../../img/check-mark.png" alt="" class="span-check"></span>
    <span class="dot"></span>
    <span class="dot"></span>
    <span>
      <div class="sub-ver-back sub-ver-back-dot">
        <div class="ver-checkbox">
            <img src="../../img/check-mark.png" alt="" class="ver-check">
        </div>
        <p class="ver-p1">E R I F Y</p>
        <p class="ver-p2">I T !</p>
      </div>
    </span>
    <span><img src="../../img/check-mark.png" alt="" class="span-check"></span>
    <span class="dot"></span>
    <span>
      <div class="sub-ver-back sub-ver-back-dot">
        <div class="ver-checkbox">
            <img src="../../img/check-mark.png" alt="" class="ver-check">
        </div>
        <p class="ver-p1">E R I F Y</p>
        <p class="ver-p2">I T !</p>
      </div>
    </span>
    <span><img src="../../img/check-mark.png" alt="" class="span-check"></span>
    <span class="dot"></span>
    <span><img src="../../img/check-mark.png" alt="" class="span-check"></span>
    <span class="dot"></span>
    <span class="dot"></span>
    <span class="dot"></span>
 </div>
  <div class="animate__animated animate__fadeIn">
    <div class="sub-ver-back sub-ver-back-0">
      <div class="ver-checkbox">
          <img src="../../img/check-mark.png" alt="" class="ver-check">
      </div>
      <p class="ver-p1">E R I F Y</p>
      <p class="ver-p2">I T !</p>
    </div>
    <fieldset id="multiplayer" hidden="">
      <legend>Enter your information</legend>
      <label for="handle">Your name or handle: </label>
      <input type="text" id="handle-multiplayer">
    </fieldset>
    <fieldset id="teacher" hidden="" style="display: block;">
      <legend class="t-head">Enter your information</legend>
      <label class="t-head t-head-2" for="handle">Your name or handle: </label>
      <input class="t-head-box" type="text" id="handle-teacher"><br>
      <label class="t-head t-head-2" for="school">School: </label>
      <input class="t-head-box" type="text" id="school"><br>
      <label class="t-head t-head-2" for="grade">Grade: </label>
      <input class="t-head-box" type="number" id="grade" step="1"><br>
      <label class="t-head t-head-2" for="city">City, State: </label>
      <input class="t-head-box" type="text" id="city">
      <div class="sub-ver-back sub-ver-back-1">
        <div class="ver-checkbox">
            <img src="../../img/check-mark.png" alt="" class="ver-check">
        </div>
        <p class="ver-p1">E R I F Y</p>
        <p class="ver-p2">I T !</p>
      </div>
    </fieldset>
    <fieldset id="game-setup">
      <legend class="t-head">Choose a Game Topic</legend>
      <div class="collapse">
        <input class="col-inp" type="radio" aria-hidden="true" name="accordion">
        <label aria-hidden="true">(game group name goes here)</label>
        <div>
          <ul></ul>
        </div>
      </div>
      <div class="start-btn">
        <button id="btn-open-game">START THE GAME</button>
      </div>
    </fieldset>
    <div class="sub-ver-back sub-ver-back-2">
      <div class="ver-checkbox">
          <img src="../../img/check-mark.png" alt="" class="ver-check">
      </div>
      <p class="ver-p1">E R I F Y</p>
      <p class="ver-p2">I T !</p>
    </div>
</div>
  <div class="shadowed"><h1 class="toast">TEST VERSION OF GAME SETUP</h1></div>
  <script>

    async function fetchQuestions(game) {
      let gc = await request(`game_category?select=categories,no_questions&game=eq.${game}`)
      // console.log('gc', gc)
      let result = await Promise.all(gc.map( async cat => {
        const buf = await request( `random_question?select=title&game=eq.${game}&categories=eq.${cat.categories}&limit=${cat.no_questions}`)
        return buf.map( r => ({title: r.title, categories: cat.categories}) )
      }))
      return result.flat().sort(() => Math.random() - 0.5).map( (r,i) => ({title: r.title, categories: r.categories, sequence: i}) )
    }


    async function main() {
      $('#handle-multiplayer').value = localStorage.handleMultiplayer || ''
      $('#handle-teacher').value = localStorage.handleTeacher || ''
      $('#school').value = localStorage.school || ''
      $('#grade').value = localStorage.grade || ''
      $('#city').value = localStorage.city || ''

      let params = {}
      new URLSearchParams(location.hash.slice(1)).forEach( (v, k) => params[k] = `${v}`)
      console.log('params', params)
      if (params.hasOwnProperty('teacher')) {
        document.title += ' - Teacher'
        $('#teacher').style.display = 'block'
      }
      else if (params.hasOwnProperty('multiplayer')) {
        document.title += ' - Multiplayer'
        $('#multiplayer').style.display = 'block'
      }
      else document.title += ' - SinglePlayer'

      var questions = []

      let games =  {Civics: [], Voting: [], News: []} // team asked for these to be the first three game groups listed
      let buf = await request('game?select=name,description,game_group,game_category(no_questions)&name=neq.(none)&game_status=eq.Production&game_group=not.is.null&order=game_group,name')
      buf.forEach(row => {
        if (!games[row.game_group]) games[row.game_group] = []
        games[row.game_group].push(row)
      })
      // console.log('games', games)
      let container = $('#game-setup .collapse')
      let groupTmpl = document.createElement('div')
      while (container.firstElementChild) groupTmpl.appendChild(container.removeChild(container.firstElementChild))
      // console.log('groupTmpl', groupTmpl)
      Object.keys(games).forEach( (gn, i) => {
        let newItem = groupTmpl.cloneNode(true)
        let input = newItem.querySelector('input')
        let label = newItem.querySelector('label')
        let content = newItem.querySelector('div ul')
        // console.log('  group', gn, i, input, label, content)

        input.id = `group-${i}`
        input.onclick = () => {
          document.querySelectorAll('.col-lab').forEach( n => n.style.color = 'white' )
          label.style.color = 'black'
        }
        label.setAttribute('for', input.id)
        label.classList.add('col-lab')
        label.style.color = 'white'
        
        if (i == 0) {
          input.checked = true
          label.style.color = 'black'
        }

        label.innerHTML = `â–¶&nbsp;&nbsp;${gn}`
        content.innerHTML = games[gn].map (r => {
          let cs = r.game_category.length
          if (cs == 0) return ''
          let qs = r.game_category.map( gc => gc.no_questions ).reduce( (a,c) => a + c , 0)

          return `<li><label>
            <input type="radio" name="game" value="${r.name}"" />
            <strong title="${r.description}">${r.name}</strong> - ${qs} questions
            </label></li>` 
        }).join('\n')
        
        while (newItem.firstElementChild) container.appendChild(newItem.removeChild(newItem.firstElementChild))
      })

      $('#btn-open-game').onclick = async evt => {
        evt.preventDefault()
        const checked = $('input[name=game]:checked')
        if (checked == null) {
          alert('Please select a Game Plan first.')
          return
        }
        const game = checked.value
        console.log('teacher?', $('#teacher').style.display == 'block', 'multiplayer?', $('#multiplayer').style.display == 'block')
        if ($('#teacher').style.display == 'block') {
          let errs = []
          if ($('#handle-teacher').value == '') errs.push('Missing Teacher handle')
          if ($('#school').value == '') errs.push('Missing School')
          if ($('#grade').value == '') errs.push('Missing Grade')
          if ($('#city').value == '') errs.push('Missing City')
          if (errs.length > 0) {
            alert(`PLEASE COMPLETE THE FORM:\n\n${errs.join('\n\t')}`)
            return
          }


          localStorage.handleTeacher = $('#handle-teacher').value
          localStorage.school        = $('#school').value        
          localStorage.grade         = $('#grade').value         
          localStorage.city          = $('#city').value
          let params = [
            `gameName=${game}`,
            `handleTeacher=${$('#handle-teacher').value}`,
            `school=${$('#school').value}`,
            `grade=${$('#grade').value}`,
            `city=${$('#city').value}`,
          ]
          location.assign(`./dashboard.html#${params.join('&')}`)
        }
        else if ($('#multiplayer').style.display == 'block') {
          if ($('#handle-multiplayer').value == '') {
            alert('Please enter your Handle.')
            return
          }
          localStorage.handleMultiplayer = $('#handle-multiplayer').value
          // alert ('multiplayer dashboard not yet supported')
          location.assign(`./dashboard.html#gameName=${game}&handleMultiplayer=${$('#handle-multiplayer').value}`)
        }
        else location.assign(`../index.html#gameName=${game}`) // It's single player, go right to game
      }
    }

    main()

  </script>
  <!-- Ric incorporated the logic into his own script <script src="../../script-t-dash.js"></script> -->
</body>
<loom-container id="lo-engage-ext-container"><loom-shadow classname="resolved"></loom-shadow></loom-container><loom-container id="lo-companion-container"><loom-shadow classname="resolved"></loom-shadow></loom-container>
</html>
